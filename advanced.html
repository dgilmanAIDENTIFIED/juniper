
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>8. Layers and binaries &#8212; juniper  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="7. Features" href="features.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="layers-and-binaries">
<h1>8. Layers and binaries<a class="headerlink" href="#layers-and-binaries" title="Permalink to this headline">¶</a></h1>
<p>In this section we are going to discuss how to use aws <a class="reference external" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html">lambda layers</a> and juniper
to package a lambda function that requires additional OS packages to be installed
in the build container.</p>
<p>For most use cases, the lambci container used by juniper has the dev system libraries
necesary to pip install a set of dependencies. However, when this is not the case,
you need to build a docker image with the missing dependencies that juniper can
use for build purposes.</p>
<div class="section" id="tl-dr">
<h2>8.1. TL;DR<a class="headerlink" href="#tl-dr" title="Permalink to this headline">¶</a></h2>
<p>Look at the setup of juniper’s examples/ridge. The main takeaways are:</p>
<ul class="simple">
<li>Use a dockerfile to install missing OS libraries</li>
<li>Use the <a class="reference external" href="http://lambci.org/">lambci build</a> images as the base image of the dockerfile</li>
<li>If binaries need to be included in the final artifact, copy them explicitly
to the <strong>/var/task/lambda_lib/</strong> folder. Juniper will know what to do with those</li>
<li>Build new docker image locally (see the ridge/Makefile) build command</li>
<li>Use the locally built image in the juniper manifest (ridge/manifest.yml)</li>
</ul>
</div>
<div class="section" id="sample-project">
<h2>8.2. Sample Project<a class="headerlink" href="#sample-project" title="Permalink to this headline">¶</a></h2>
<p>Ridge is a simple example included in the juniper codebase used to show the recommended
configuration to install and build an advanced python package.</p>
<p>The ridge project will be used to illustrate three things:</p>
<ul class="simple">
<li>How to use docker to build a image with missing dependencies</li>
<li>How to use aws lambda layers</li>
<li>How to include a set of binaries in zip artifact of the lambda function</li>
</ul>
<p>To get started, make sure you clone the project and install juni:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="nd">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="n">eabglobal</span><span class="o">/</span><span class="n">juniper</span><span class="o">.</span><span class="n">git</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cd</span> <span class="n">juniper</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">venv</span> <span class="n">venv</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">source</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">e</span> <span class="o">.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cd</span> <span class="n">examples</span><span class="o">/</span><span class="n">ridge</span>
</pre></div>
</div>
<p>This example will use a simple lambda function that has a dependency on the
xmlsec python library. Without the following steps, building a lambda function with
juniper using a requirements.txt file that has the xmlsec package fails with the
following error:</p>
<img alt="_images/xmlsec_fail.png" src="_images/xmlsec_fail.png" />
<p>You can reproduce this error by commenting out this line in the manifest file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">layers</span><span class="p">:</span>

  <span class="nt">xmlsec</span><span class="p">:</span>
    <span class="c1"># image: juniper/xmlsec</span>
    <span class="nt">requirements</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./requirements/xmlsec_layer.txt</span>
</pre></div>
</div>
<p>The <a class="reference external" href="https://pythonhosted.org/xmlsec/install.html">xmlsec documentation</a> clearly indicates that in order to install this python
package, a developer needs to have the following OS libraries:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">yum</span> <span class="n">install</span> <span class="n">libxml2</span><span class="o">-</span><span class="n">devel</span> <span class="n">xmlsec1</span><span class="o">-</span><span class="n">devel</span> <span class="n">xmlsec1</span><span class="o">-</span><span class="n">openssl</span><span class="o">-</span><span class="n">devel</span> <span class="n">libtool</span><span class="o">-</span><span class="n">ltdl</span><span class="o">-</span><span class="n">devel</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pip</span> <span class="n">install</span> <span class="n">xmlsec</span>
</pre></div>
</div>
</div>
<div class="section" id="installing-os-libraries">
<h2>8.3. Installing OS libraries<a class="headerlink" href="#installing-os-libraries" title="Permalink to this headline">¶</a></h2>
<p>To install a set of libraries, create a new Dockerfile as follows:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">FROM lambci/lambda:build-python3.6</span>

<span class="l l-Scalar l-Scalar-Plain">RUN yum install libxml2-devel xmlsec1-devel xmlsec1-openssl-devel libtool-ltdl-devel -y</span>

<span class="l l-Scalar l-Scalar-Plain">RUN mkdir -p /var/task/lambda_lib/</span>
<span class="l l-Scalar l-Scalar-Plain">RUN cp /usr/lib64/libxmlsec1-openssl.so /var/task/lambda_lib/</span>
<span class="l l-Scalar l-Scalar-Plain">RUN cp /usr/lib64/libxmlsec1.so.1 /var/task/lambda_lib/</span>
</pre></div>
</div>
<p>This is the content of the /ridge/docker/Dockerfile.xmlsec. To make sure that
your build artifact will be compatible with the lambda execution environment, we
recommend you use the <strong>lambci/lambda:build-python3.6</strong> as the starting point of
the docker file. Juniper uses this image by default.</p>
<p>The second part of the file copies two binaries that <strong>must</strong> be included in the
zip artifact of the lambda function for it to correctly function at run time. If
you ommit the copying of the <em>.so files to the lambda_lib directory, you function
will correctly generate a zip artifact, however, the function will **NOT*</em> work
when you run it.</p>
<p>These two files are required by the xmlsec library only! Different dependencies have
different needs, you need to know and understand the needs of the library you are
trying to install and ultimate include in the artifact of the lambda function.</p>
<p>This <a class="reference external" href="https://github.com/Miserlou/lambda-packages/tree/master/lambda_packages">curated list</a> of pre-compiled python packages includes the set of “Shared Object”
(.so) files for most use cases. Use this list to identify the set of files that you need.
Once you know what files your library depends on, copy the two or three files your package
needs from the /usr/lib64 folder in your container over to the lambda_lib directory.</p>
</div>
<div class="section" id="lambda-lib-directory">
<h2>8.4. lambda_lib directory<a class="headerlink" href="#lambda-lib-directory" title="Permalink to this headline">¶</a></h2>
<p>This is the folder that juniper uses to retrieve a set of binaries that need to
be included in the final artifact. The main reason to use this shared folder
is that the binaries go in different places depending on the type of resource
being built (lambda function/lambda layer).</p>
<p>In the dockerfile, once you have identified the .so files that you need to include
in your lambda artifact, cp those files over to the <cite>/var/task/lambda_lib/</cite> directory.
When building a lambda function, these files will be included at the top level of the
zip file. When building a lambda layer, these files need to be placed under a <cite>lib</cite>
directory. Juniper will take care of that for you, as long as you put the files in the
lambda_dir.</p>
</div>
<div class="section" id="docker-build">
<h2>8.5. docker build<a class="headerlink" href="#docker-build" title="Permalink to this headline">¶</a></h2>
<p>With the given dockerfile created, add the following line to the makefile.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">build</span><span class="p">:</span>
    <span class="l l-Scalar l-Scalar-Plain">docker build -t juniper/xmlsec -f docker/Dockerfile.xmlsec .</span>
    <span class="l l-Scalar l-Scalar-Plain">juni build</span>
</pre></div>
</div>
<p>The docker build command will create a new docker image called juniper/xmlsec. If
nothing has changed this command does not rebuild the image. It does so, only when
the docker file has changed.</p>
<p>In the juniper manifest file, use the newly built docker image for your lambda function
or your lambda layer. The final manifest looks like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">functions</span><span class="p">:</span>
  <span class="nt">sample</span><span class="p">:</span>
      <span class="nt">requirements</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./requirements/base.txt</span>
      <span class="nt">include</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./lambda_function.py</span>

<span class="nt">layers</span><span class="p">:</span>
  <span class="nt">xmlsec</span><span class="p">:</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">juniper/xmlsec</span>
      <span class="nt">requirements</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./requirements/xmlsec_layer.txt</span>
</pre></div>
</div>
<p>With these changes you can now build and deploy the application using the commands
in the make file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">make</span> <span class="n">build</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">make</span> <span class="n">deploy</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">juniper</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">1. Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="concepts.html">3. Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="concepts.html#lambda-build-tool">4. Lambda Build Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="concepts.html#microservices">5. Microservices</a></li>
<li class="toctree-l1"><a class="reference internal" href="concepts.html#tool-survey">6. Tool Survey</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">7. Features</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">8. Layers and binaries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#tl-dr">8.1. TL;DR</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sample-project">8.2. Sample Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installing-os-libraries">8.3. Installing OS libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lambda-lib-directory">8.4. lambda_lib directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#docker-build">8.5. docker build</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="features.html" title="previous chapter">7. Features</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, EAB Tech Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/advanced.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>